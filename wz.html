<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wydanie – Le Magazynier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caveat&display=swap" rel="stylesheet">
  <audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      background-color: #1c1c1c;
      font-family: sans-serif;
      color: #f5f5f5;
    }
    .form-wrapper {
      max-width: 500px;
      margin: auto;
      background: #333;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 90vh;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .logo {
      font-family: 'Informal Roman', cursive;
      font-size: 2.5rem;
    }
    .back-button {
      width: 25%;
      min-width: 80px;
      padding: 8px;
      font-size: 0.9rem;
      border: none;
      border-radius: 6px;
      background-color: #555;
      color: #fff;
      cursor: pointer;
      text-align: center;
    }
    .data-display {
      font-size: 0.9rem;
      background-color: #444;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 16px auto;
    }
    #scan-result {
      text-align: center;
      color: #00ff00;
      margin-bottom: 12px;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      font-size: 1rem;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #222;
      color: #f5f5f5;
    }
    input::placeholder { color: #999; }

    ul { list-style: none; padding: 0; }
    li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #666;
    }
    .note-input {
      width: 22%;
      padding: 6px;
      font-size: 0.9rem;
      background-color: #1c1c1c;
      color: #f5f5f5;
      text-transform: uppercase;
      border: 1px solid #555;
      border-radius: 4px;
    }
    .code-text {
      flex: 1;
      background-color: #1c1c1c;
      color: #f5f5f5;
      border: 1px solid #555;
      padding: 6px;
    }
    .remove-btn {
      color: red;
      cursor: pointer;
      font-weight: bold;
      padding: 0 6px;
    }
    .footer-logo { text-align: center; margin-top: 20px; }
    .footer-logo img { width: 40%; max-width: 2000px; }

    .checkbox-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .checkbox-row label {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #444;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    .checkbox-row input { width: 20px; height: 20px; }

    .list-header { display: flex; align-items: center; gap: 8px; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid #666;
      border-radius: 999px;
      font-size: .85rem;
      background: #222;
      color: #f5f5f5;
    }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <div>
      <div class="header-row">
        <div class="logo">WuZetka</div>
        <button class="back-button" onclick="goBack()">← Cofnij</button>
      </div>

      <div class="data-display" id="daneUzytkownika">Wczytywanie danych...</div>

<div id="scan-result" style="display: none;"></div>
<button id="startScanBtn" onclick="startScanning()" style="
  width: 200px; height: 50px;
  font-size: 1rem; font-weight: bold;
  background-color: #2e7d32; color: #fff;
  border: none; border-radius: 12px;
  cursor: pointer; display: block; margin: 10px auto;">
  Skanuj
</button>
<div id="reader" style="display: none; width: 100%; max-width: 400px; margin: 16px auto;"></div>


      <div style="display: flex; gap: 8px; margin: 10px 0;">
        <input type="text" id="manualInput" placeholder="Dodaj kod ręcznie" autocomplete="off" style="flex: 1; padding: 4px; font-size: 1rem;">
        <button onclick="addManual()" style="width: 20%; min-width: 80px; font-size: 0.8rem; padding: 4px;">Dodaj S/N</button>
      </div>

      <div class="list-header">
        <h3 style="margin:0;">Lista kodów</h3>
        <span class="badge" id="codeCount">0</span>
      </div>
      <ul id="codeList"></ul>

      <input type="text" id="dodatkoweInfo" placeholder="Dodatkowe informacje (opcjonalne)" autocomplete="off">

      <div class="checkbox-row">
        <label><input type="radio" name="typDostawy" value="Załadunek"> Załadunek</label>
        <label><input type="radio" name="typDostawy" value="Doładunek"> Doładunek</label>
      </div>

      <button onclick="sendData()">Wyślij dane</button>
      <p id="status"></p>
    </div>

    <div class="footer-logo">
      <img src="https://jarogpbs.github.io/MagOrlean/Jaro.png" alt="Created by Jaro">
    </div>
  </div>

  <script>
    function goBack() {
      window.location.href = "index.html";
    }

    const scriptURL = "https://script.google.com/macros/s/AKfycby5xJAHto5XHSwXGWDoaUyjvZHB_rEBd6pqhUkk5JrvPw807HazHGvMKr00ZrG5rLGwIg/exec";
    const allowed = [
      "FM", "LQ", "RQ", "XS", "ODL", "ODR", "CU", "DUO", "HICU", "HIDUO", "FMB", "LQB", "RQB",
      "FMBRBQ", "ODBRBQ", "CUBQ", "DUOBQ", "HIUNO"
    ];

    let codes = [];

    function updateList() {
      const list = document.getElementById("codeList");
      const count = document.getElementById("codeCount");
      list.innerHTML = "";
      count.textContent = String(codes.length);

      codes.forEach((item, index) => {
        const li = document.createElement("li");

        const inputNote = document.createElement("input");
        inputNote.type = "text";
        inputNote.placeholder = "TYP";
        inputNote.className = "note-input";
        inputNote.value = item.note || "";
        inputNote.setAttribute("list", "typList");
        inputNote.style.borderColor = item.note && allowed.includes(item.note) ? "#0f0" : "#555";

        inputNote.oninput = () => {
          const val = inputNote.value.toUpperCase().trim();
          inputNote.value = val;
          codes[index].note = val;
          inputNote.style.borderColor = allowed.includes(val) ? "#0f0" : "red";
          localStorage.setItem("codesWZ", JSON.stringify(codes));
        };

        const codeText = document.createElement("input");
        codeText.type = "text";
        codeText.value = item.value;
        codeText.className = "code-text";
        codeText.oninput = () => {
          codes[index].value = codeText.value.toUpperCase().trim();
          localStorage.setItem("codesWZ", JSON.stringify(codes));
        };

        const remove = document.createElement("span");
        remove.className = "remove-btn";
        remove.textContent = "✕";
        remove.title = "Usuń";
        remove.onclick = () => {
          codes.splice(index, 1);
          localStorage.setItem("codesWZ", JSON.stringify(codes));
          updateList();
        };

        li.appendChild(inputNote);
        li.appendChild(codeText);
        li.appendChild(remove);
        list.appendChild(li);
      });

      localStorage.setItem("codesWZ", JSON.stringify(codes));
    }

    function addManual() {
      const input = document.getElementById("manualInput");
      const val = input.value.trim().toUpperCase();
      if (!val) return;

      const exists = codes.find(c => (c.value || "").toUpperCase().trim() === val);
      if (!exists) {
        codes.unshift({ value: val, note: "" });
        localStorage.setItem("codesWZ", JSON.stringify(codes));
        updateList();
      }
      input.value = "";
    }

    function sendData() {
      if (!confirm("Czy na pewno chcesz wysłać dane?")) return;

      const login = localStorage.getItem("login") || "";
      const trasa = localStorage.getItem("trasa") || "";
      const tablica = localStorage.getItem("tablica") || "";
      const dodatkoweInfo = document.getElementById("dodatkoweInfo").value.trim();
      const typDostawy = document.querySelector('input[name="typDostawy"]:checked')?.value || "";

      if (!login || !trasa || !tablica || codes.length === 0 || !typDostawy) {
        alert("Brakuje danych lub lista kodów jest pusta.");
        return;
      }

      if (!codes.every(c => typeof c.note === "string" && c.note.trim() !== "")) {
        alert("Wszystkie pola TYP muszą być uzupełnione.");
        return;
      }

      const finalData = codes.map(c => `${c.value} | ${c.note}`);

      const formData = new FormData();
      formData.append("login", login);
      formData.append("trasa", trasa);
      formData.append("tablica", tablica);
      formData.append("dodatkowe", dodatkoweInfo || "-");
      formData.append("typDostawy", typDostawy);
      formData.append("kody", JSON.stringify(finalData));
      formData.append("strona", "wz");

      fetch(scriptURL, { method: "POST", body: formData })
        .then(res => res.text())
        .then(txt => {
          alert("✅ Dane wysłane.");
          codes = [];
      localStorage.removeItem("codesWZ");
      updateList();

      localStorage.removeItem("trasa");
      localStorage.removeItem("tablica");
      localStorage.removeItem("tablicaSam");
      localStorage.removeItem("tablicaNacz");

      window.location.href = "index.html";
        })
        .catch(err => {
          document.getElementById("status").innerText = "❌ Błąd: " + err;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const savedCodes = localStorage.getItem("codesWZ");
      if (savedCodes) {
        codes = JSON.parse(savedCodes);
        updateList();
      }

      const login = localStorage.getItem("login") || "brak";
      const trasa = localStorage.getItem("trasa") || "brak";
      const tablica = localStorage.getItem("tablica") || "brak";
      document.getElementById("daneUzytkownika").innerHTML = `${login}  -  ${trasa}  -  ${tablica}`;

      const html5Qr = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const backCam = cameras.find(cam => {
            const lbl = (cam.label || "").toLowerCase();
            return lbl.includes("back") || lbl.includes("environment");
          }) || cameras[0];

          html5Qr.start(backCam.id, { fps: 10, qrbox: 250 }, text => {
            const val = (text || "").toUpperCase().trim();
            const exists = codes.find(c => (c.value || "").toUpperCase().trim() === val);
            if (!exists && val) {
              codes.unshift({ value: val, note: "" });
              localStorage.setItem("codesWZ", JSON.stringify(codes));
              updateList();
              document.getElementById("scan-result").innerText = "Zeskanowano: " + val;
              if (navigator.vibrate) navigator.vibrate(100);
            }
          });
        } else {
          document.getElementById("scan-result").innerText = "❌ Nie wykryto kamery.";
        }
      }).catch(err => {
        document.getElementById("scan-result").innerText = "❌ Błąd kamery: " + err;
      });
    });
  </script>

<datalist id="typList">
  <option value="FM">
  <option value="LQ">
  <option value="RQ">
  <option value="XS">
  <option value="CU">
  <option value="DUO">
  <option value="HICU">
  <option value="HIDUO">
  <option value="HIUNO">
  <option value="ODL">
  <option value="ODR">
  <option value="FMB">
  <option value="LQB">
  <option value="RQB">
  <option value="FMBRBQ">
  <option value="ODBRBQ">
  <option value="CUBQ">
  <option value="DUOBQ">
</datalist>
  <script>
let html5Qr;
let isScanning = false;

function startScanning() {
  if (isScanning) return;
  isScanning = true;

  document.getElementById("startScanBtn").style.display = "none";
  const readerDiv = document.getElementById("reader");
  readerDiv.style.display = "block";
  readerDiv.innerHTML = "";

  html5Qr = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      const backCam = cameras.find(cam => (cam.label || "").toLowerCase().includes("back")) || cameras[0];

      html5Qr.start(backCam.id, { fps: 10, qrbox: 250 }, text => {
        stopScanning();

        const val = (text || "").toUpperCase().trim();
        const exists = codes.find(c => (c.value || "").toUpperCase().trim() === val);
        if (!exists && val) {
          codes.unshift({ value: val, note: "" });
          localStorage.setItem("codesWZ", JSON.stringify(codes));
          updateList();
        }

        if ("vibrate" in navigator) navigator.vibrate(200);
        const beep = document.getElementById("beepSound");
        if (beep) beep.play().catch(() => {});
      });
    } else {
      alert("Nie wykryto kamery.");
      isScanning = false;
    }
  }).catch(err => {
    alert("Błąd kamery: " + err);
    isScanning = false;
  });
}

function stopScanning() {
  if (html5Qr && isScanning) {
    html5Qr.stop().then(() => {
      html5Qr.clear();
      isScanning = false;
      document.getElementById("reader").style.display = "none";
      document.getElementById("startScanBtn").style.display = "inline-block";
    }).catch(err => {
      console.error("Błąd zatrzymania skanera:", err);
      isScanning = false;
    });
  }
}
</script>

</body>
</html>




